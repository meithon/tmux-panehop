#!/usr/bin/env bash

# tmux-session-switcher
# Command+Tab 風にセッションを次/前へ送り、現在セッション一覧を一瞬表示する。
# フォーカスを奪わず display-message を使うので安全。

# --- Paths & config ---
SCRIPT_DIR="$(cd -- "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WIDGET_PATH="$SCRIPT_DIR/tmux-session-widget" # デフォルトのウィジェットを固定で使う

# 表示モード: list (デフォルト) / dots
DEFAULT_WIDGET_MODE="list"
# 優先順位: 環境変数 WIDGET_MODE > tmux option @session_switcher_widget_mode > デフォルト
if [[ -z "${WIDGET_MODE:-}" ]]; then
  WIDGET_MODE=$(tmux show-option -gqv @session_switcher_widget_mode)
fi
if [[ -z "$WIDGET_MODE" ]]; then
  WIDGET_MODE="$DEFAULT_WIDGET_MODE"
fi

# --- Helpers ---
get_current_session_index() {
  local current_session
  current_session=$(tmux display-message -p '#S')
  local sessions=($(tmux list-sessions -F '#S' | sort))
  for i in "${!sessions[@]}"; do
    if [[ "${sessions[$i]}" == "$current_session" ]]; then
      echo "$i"
      return
    fi
  done
  echo 0
}

get_session_at_index() {
  local idx=$1
  local sessions=($(tmux list-sessions -F '#S' | sort))
  local total=${#sessions[@]}
  if [[ $idx -lt 0 ]]; then
    idx=$((total - 1))
  elif [[ $idx -ge $total ]]; then
    idx=0
  fi
  echo "${sessions[$idx]}"
}

create_session_list_display() {
  local current_index=$1
  if [[ ! -f "$WIDGET_PATH" ]]; then
    echo "tmux-session-widget not found: $WIDGET_PATH" >&2
    return 1
  fi
  # shellcheck source=/dev/null
  source "$WIDGET_PATH"
  case "$WIDGET_MODE" in
  dots)
    get_session_info dots 0 # dots は内部で現在セッションを取得する
    ;;
  *)
    create_session_list "$current_index"
    ;;
  esac
}

show_overlay() {
  local current_index=$1
  create_session_list_display "$current_index"
}

# --- Main ---
case "$1" in
next)
  cur=$(get_current_session_index)
  sessions=($(tmux list-sessions -F '#S' | sort))
  total=${#sessions[@]}
  new_idx=$(((cur + 1) % total))
  target=$(get_session_at_index "$new_idx")
  tmux switch-client -t "$target" \; refresh-client -S
  show_overlay "$new_idx"
  ;;
prev)
  cur=$(get_current_session_index)
  sessions=($(tmux list-sessions -F '#S' | sort))
  total=${#sessions[@]}
  new_idx=$(((cur - 1 + total) % total))
  target=$(get_session_at_index "$new_idx")
  tmux switch-client -t "$target" \; refresh-client -S
  show_overlay "$new_idx"
  ;;
*)
  echo "Usage: $0 {next|prev}" >&2
  exit 1
  ;;
esac
